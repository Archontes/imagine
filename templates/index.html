<html>
<head>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="/static/leaflet-src.js"></script>
<script src="/static/jquery-2.1.1.min.js"></script>

<style type="text/css">
#map { height: 100%; width: 100%; }

.info {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}

</style>

</head>

<body>
<div id="map" />

<script>

var map = L.map('map').setView([ {{ lat }}, {{ long }}], {{ zoom }});

MyTileLayer = L.TileLayer.extend({
  _loadTile: function (tile, tilePoint) {
        // this is just copied from the superclass
		tile._layer  = this;
		tile.onload  = this._tileOnLoad;
		tile.onerror = this._tileOnError;
		this._adjustTilePoint(tilePoint);
		tile.src     = this.getTileUrl(tilePoint);
        // this is special sauce - add zoom,x,y to tile object
        tile.x = tilePoint.x;
        tile.y = tilePoint.y;
        tile.z = tilePoint.z;
        // copied
		this.fire('tileloadstart', {
			tile: tile,
			url: tile.src,
		});
	},

});

tiles = new MyTileLayer('{{ tileurl }}', {
			maxZoom: 18,
			attribution: 'DECaLS',
			id: '{{ layer }}'
		});
tiles.addTo(map);

function catLoaded(result) {
}

function onTileLoadStart(e) {
  tile = e.tile;

  // fugly
  tilePoint = L.Point(tile.x, tile.y);
  caturl = L.Util.template('{{ caturl }}', L.extend({
			//s: tiles._getSubdomain(tilePoint),
            s: 'a',
			z: tile.z,
			x: tile.x,
			y: tile.y
		}, tiles.options));
  console.log('caturl: ' + caturl);

  $.getJSON(caturl, catLoaded);
  console.log('TileLoadStart: z ' + tile.z +
    ', x,y (' + tile.x + ',' + tile.y + ')');
}


function onTileUnload(e) {
  tile = e.tile;
  console.log('TileUnload: ' + tile.toString());
  console.log('TileUnload: z ' + tile.z +
    ', x,y (' + tile.x + ',' + tile.y + ')');
}

tiles.on('tileloadstart', onTileLoadStart);
tiles.on('tileunload',    onTileUnload);



// L.marker([ {{ lat }}, {{ long }}]).addTo(map)
// .bindPopup("<b>Hello world!</b><br />I am a popup.").openPopup();

// L.circle([ {{ lat }}, {{ long }}], 500, {
// color: 'red',
// fillColor: '#f03',
// fillOpacity: 0.5
// }).addTo(map).bindPopup("I am a circle.");
//
// L.polygon([
// [7.0, 242.0],
// [7.1, 242.0],
// [7.1, 242.1],
// [7.0, 242.1],
// ]).addTo(map).bindPopup("I am a polygon.");

var popup = L.popup();

function onMapClick(e) {
ra = 180 - e.latlng.lng;
dec = e.latlng.lat;
popup.setLatLng(e.latlng)
     .setContent("Click: RA,Dec = " + ra.toFixed(4) + ", " + dec.toFixed(4) +
           "<br/><a href=\"{{ baseurl }}ra=" + ra.toFixed(4) + '&dec=' + dec.toFixed(4) + '&zoom=' + map.getZoom()
                          + "\">link here</a>")
     .openOn(map);
}

map.on('click', onMapClick);


var info = L.control();
info.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
    this._div.innerHTML = '{{ ra|floatformat:4}}, {{ dec|floatformat:4}}';
    return this._div;
};
info.addTo(map);

function onMouseMove(e) {
    ra = 180 - e.latlng.lng;
    dec = e.latlng.lat;
    info._div.innerHTML = 'RA,Dec = ' + ra.toFixed(4) + ", " + dec.toFixed(4);
}

map.on('mousemove', onMouseMove);

{{ polygons }}

</script>

</body>

</html>
