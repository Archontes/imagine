{% extends "base.html" %}
{% load static %}

{% block header %}
<link rel="stylesheet" href="{% static "leaflet-0.7.3.css" %}" />
<script src="{% static "leaflet-src.js" %}"></script>
<script src="{% static "jquery-2.1.1.min.js" %}"></script>
<script src="{% static "leaflet-pip-20150130.min.js" %}"></script>
<script src="{% static "leaflet-zoomslider-0.6.1.js" %}"></script>
<link rel="stylesheet" href="{% static "leaflet-zoomslider-0.6.1.css" %}" />
<script src="{% static "leaflet.draw-0.2.4.js" %}"></script>
<link rel="stylesheet" href="{% static "leaflet.draw-0.2.4.css" %}" />
<script src="{% static "leaflet.measurecontrol-20150626.js" %}"></script>
<link rel="stylesheet" href="{% static "leaflet.measurecontrol-20150626.css" %}" />
<script src="{% static "leaflet.label-20150521.js" %}"></script>
<link rel="stylesheet" href="{% static "leaflet.label-20150521.css" %}" />

<style type="text/css">
#map { height: 100%; width: 100%; padding: 1;}

#thebody { margin:1; }

.info {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}

.inbrickccd {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}

.inbrickccd ul {
    margin-top: 0pt;
}

.highccd {
    color: red;
}
.highccd:link {
    color: red;
}
.highccd:visited {
    color: red;
}
.highexp:visited {
    color: red;
}

.leaflet-container {
//background: #000;
background: #242424;
}

.leaflet-control-scale-line {
    font-size: 200%;
    margin-bottom: 15px;
}

#gotosubmit {
    font-size: 100%
}
#gotocancel {
    font-size: 100%
}

</style>

{% endblock %}

{% block body %}
<body id="thebody">
<div id="map" />

<script>
MyTileLayer = L.TileLayer.extend({
    _loadTile: function (tile, tilePoint) {
        // this is just copied from the superclass
        tile._layer  = this;
        tile.onload  = this._tileOnLoad;
        tile.onerror = this._tileOnError;
        this._adjustTilePoint(tilePoint);
        tile.src     = this.getTileUrl(tilePoint);
        // <special sauce> - add zoom,x,y to tile object;
        tile.tilex = tilePoint.x;
        tile.tiley = tilePoint.y;
        tile.z = tilePoint.z;
        // </special sauce>
        // copied
        this.fire('tileloadstart', {
            tile: tile,
            url: tile.src,
        });
    }
});

// A subclass that switches URL patterns depending on zoom range.
ZoomRangeTileLayer = MyTileLayer.extend({
    options: {
      urlPatterns: [],
    },
	getTileUrl: function (tilePoint) {
        urlpat = this._getUrlPattern(tilePoint.z);
		return L.Util.template(urlpat, L.extend({
			s: this._getSubdomain(tilePoint),
			z: tilePoint.z,
			x: tilePoint.x,
			y: tilePoint.y
		}, this.options));
	},
    _getUrlPattern: function (zoom) {
        url = this._url;
        for (var i=0; i<this.options.urlPatterns.length; i++) {
            zlo  = this.options.urlPatterns[i][0];
            zhi  = this.options.urlPatterns[i][1];
            zurl = this.options.urlPatterns[i][2];
            if ((zoom >= zlo) && (zoom <= zhi)) {
                url = zurl;
            }
        }
        return url;
    },
});


MyLayerControl = L.Control.Layers.extend({
    // copied from leaflet-src.js
	_onInputClick: function () {
		var i, input, obj,
		    inputs = this._form.getElementsByTagName('input'),
		    inputsLen = inputs.length;

		this._handlingClick = true;

        var adding;
        var removing;
        //console.log('Click on input layer selector');
		for (i = 0; i < inputsLen; i++) {
			input = inputs[i];
			obj = this._layers[input.layerId];
			if (input.checked && !this._map.hasLayer(obj.layer)) {
                //console.log('Layer selector: adding ' + obj.name);
                adding = obj;
                //console.log('Layer selector: done adding ' + obj.name);
			} else if (!input.checked && this._map.hasLayer(obj.layer)) {
                //console.log('Layer selector: removing ' + obj.name);
                removing = obj;
                //console.log('Layer selector: done removing ' + obj.name);
			}
		}
        if ((adding != undefined) && (removing != undefined)) {
            //console.log('Layer selector: switching base layers from ' + removing.name + ' to ' + adding.name);
            if (!adding.overlay) {
                this._map.fire('prebaselayerchange', {'removing':removing.layer,
                                                      'adding':adding.layer});
            }
        }
        if (adding != undefined) {
		    this._map.addLayer(adding.layer);
        }
        if (removing != undefined) {
		    this._map.removeLayer(removing.layer);
        }
        if ((adding != undefined) && (removing != undefined)) {
            //console.log('Layer selector: done switching base layers from ' + removing.name + ' to ' + adding.name);
            if (!adding.overlay) {
                this._map.fire('postbaselayerchange', {'removing':removing.layer,
                                                       'adding':adding.layer});
            }
        }

		this._handlingClick = false;
		this._refocusOnMap();
	}
});

function getkeys(obj) {
    s = '';
    for (k in obj) {
        if (s.length) {
            s += ', ';
        }
        s += k;
    }
    return s;
}

var subdomains = {{ subdomains|safe }};

function long2ra(lng) {
    ra = 180. - lng;
    while (ra < 0) {
        ra += 360.;
    }
    while (ra > 360) {
        ra -= 360.;
    }
    return ra;
}

function wrap_long(lng, clong) {
    while (lng < clong-180) {
      lng += 360;
    }
    while (lng > clong+180) {
      lng -= 360;
    }
    return lng;
}

function ra2long_C(ra, clong) {
    lng = 180 - ra;
    lng = wrap_long(lng, clong);
    return lng;
}

function dec2lat(dec) {
  return dec;
}
function lat2dec(lat) {
  return lat;
}

function getSubdomain(x,y) {
	return subdomains[Math.abs(x + y) % subdomains.length];
}

function fluxToMag(f) {
    return -2.5 * (Math.log(f)/Math.log(10.) - 9);
}

function cutout_radec_link(ra, dec) {
    return '<a href="{% url 'cutouts' %}?ra=' + ra.toFixed(4) + '&dec=' + dec.toFixed(4) + '&name=' + idname + '">' +
        ra.toFixed(4) + ', ' + dec.toFixed(4) + '</a>';
}

function onSourceClick(e) {
    src = e.target;
    fluxstr = '';
    if ('g' in src.fluxes) {
        fluxstr += 'g=' + fluxToMag(src.fluxes.g).toFixed(2);
    }
    if ('r' in src.fluxes) {
        fluxstr += ', r=' + fluxToMag(src.fluxes.r).toFixed(2);
    }
    if ('z' in src.fluxes) {
        fluxstr += ', z=' + fluxToMag(src.fluxes.z).toFixed(2);
    }
    nobs_g = 0
    if ('g' in src.nobs) {
	nobs_g = src.nobs.g;
    }
    nobs_r = 0
    if ('r' in src.nobs) {
	nobs_r = src.nobs.r;
    }
    nobs_z = 0
    if ('z' in src.nobs) {
	nobs_z = src.nobs.z;
    }

    txt = 'Source RA,Dec = ' + cutout_radec_link(src.ra, src.dec) +
        '<br/>Source type: ' + src.type +
        '<br/>Mags: ' + fluxstr +
        '<br/>Brick: ' + src.brickname + ', Objid: ' + src.objid +
	'<br/>Number of exposures: g=' + nobs_g + ', r=' + nobs_r + ', z=' + nobs_z;
    popup.setLatLng(e.latlng).setContent(txt).openOn(map);
}

function catLoaded(zoom, tilex, tiley, result) {
    //console.log('catloaded:' + result);
    if (!showSources) {
        return;
    }
    //console.log('catloaded:' + result['rd']);
    rdlist = result['rd'];
    objtype = result['sourcetype'];
    fluxes = result['fluxes'];
    nobs = result['nobs'];
    var circleList = new Array(rdlist.length);
    var clong = map.getCenter().lng;
    for (i=0, len=rdlist.length; i<len; i++) {
        r = rdlist[i][0];
        d = rdlist[i][1];
        lat = dec2lat(d);
        lng = ra2long_C(r, clong);
        
        color = 'blue';
        if (objtype == undefined) {
            typ = 'nil';
        } else {
            typ = objtype[i];
	    // PSF
            if (objtype[i] == 'P') {
                color = '#9AFE2E'; //#D8F781'; //'green';
	    } else if (objtype[i] == 'S') {
		// Simple
                color = 'orange';
	    //if (objtype[i] == 'S') {
            } else if (objtype[i] == 'D') {
                color = 'red';
            } else if (objtype[i] == 'E') {
                color = '#58ACFA'; // blue
            } else if (objtype[i] == 'C') {
                color = '#DA81F5'; // magenta
            }
        }

        //circ = L.circleMarker([lat, lng], {'radius':10, 'color':color,
        //                                 'fillOpacity':0, 'weight':5});
        circ = L.circle([lat, lng], 30, {'color':color,
                                         'fillOpacity':0, 'weight':5});
        circ.ra = r;
        circ.dec = d;
        circ.type = typ;

        if (fluxes == undefined) {
            circ.fluxes = {};
        } else {
            circ.fluxes = fluxes[i];
        }

        if (nobs == undefined) {
            circ.nobs = {};
        } else {
            circ.nobs = nobs[i];
        }

        if (result.bricknames == undefined) {
            circ.brickname = '';
        } else {
            circ.brickname = result.bricknames[i];
        }
        if (result.objids == undefined) {
            circ.objid = '';
        } else {
            circ.objid = result.objids[i];
        }

        circ.on('click', onSourceClick);

        circleList[i] = circ;
    }
    circles = L.layerGroup(circleList);
    //circles = L.featureGroup(circleList);
    //circles.on('click', onSourceClick);
    sourcesGroup.addLayer(circles);
    // save this for later.
    key = ''+result['zoom']+':'+result['tilex']+':'+result['tiley'];
    console.log('catalog loaded: key ' + key);
    catLayers[key] = circles;
}

function ngcLoaded(zoom, tilex, tiley, result) {
    if (!showNgc) {
        return;
    }

    c = map.getCenter();
    clong = c.lng
    //console.log('NGC loaded: map center ' + c.lng + ',' + c.lat);

    rdlist = result['rd'];
    radius = result['radiusArcsec'];
    names = result['name'];

    showlabels = (map.getZoom() >= ngcLabelsMinZoom);

    var circleList = new Array(rdlist.length);
    for (i=0, len=rdlist.length; i<len; i++) {
        r = rdlist[i][0];
        d = rdlist[i][1];
        lat = dec2lat(d);
        lng = ra2long_C(r, clong);
        
	// arcsec to meters:
	meters = radius[i] * 30.87;
	if (meters == 0.) {
	    meters = 30;
	}

	//color = '#8080a0';
	color = '#ffffff';

        circ = L.circle([lat, lng], meters, {'color':color,
                                             'fillOpacity':0, 'weight':5});
        circ.ra = r;
        circ.dec = d;
	circ.name = names[i];

	circ._showLabelAdded = true;
	circ.bindLabel(circ.name, { noHide: true });
	circ.label._latlng = L.latLng(lat,lng);

	if (showlabels) {
	    circ.on('remove', function(e){
		console.log('Removing label for ' + e.target.name);
		map.removeLayer(e.target.label);
	    });
	}

        circleList[i] = circ;
    }
    circles = L.layerGroup(circleList);
    ngcGroup.addLayer(circles);
    if (showlabels) {
	// show labels
	for (i=0; i<circleList.length; i++) {
	    circ = circleList[i];
	    map.showLabel(circ.label);
	}
    }

    // save this for later.
    key = ''+result['zoom']+':'+result['tilex']+':'+result['tiley'];
    //console.log('NGC loaded: key ' + key);
    ngcLayers[key] = circles;
}

function specLoaded(counter, result) {
    console.log('specLoaded: counter ' + counter);
    if (!showSpec) {
        return;
    }
    for (var k in specLayers) {
	if (k > counter) {
	    console.log('spec: counter ' + k + ' exists; bye');
	    return;
	}
    }

    for (var k in specLayers) {
	console.log('spec: counter ' + k + ' exists');
    }

    rdlist = result['rd'];
    names = result['name'];

    mjds = result['mjd'];
    plates = result['plate'];
    fibers = result['fiber'];

    showlabels = (map.getZoom() >= specLabelsMinZoom);

    //console.log('Creating ' + rdlist.length + ' labels');

    var circleList = new Array(rdlist.length);
    var clong = map.getCenter().lng;
    for (i=0, len=rdlist.length; i<len; i++) {
        r = rdlist[i][0];
        d = rdlist[i][1];
        lat = dec2lat(d);
        lng = ra2long_C(r, clong);

	// ~ 10 arcsec
	meters = 300;
	color = '#ffffff';
        circ = L.circle([lat, lng], meters, {'color':color,
                                             'fillOpacity':0, 'weight':5});
        circ.ra = r;
        circ.dec = d;

	//console.log('ra,dec ' + r + ',' + d + ', lat,long ' + lat + ', ' + lng + ': ' + names[i]);

	if (showlabels) {
	    circ.name = '<a href="http://dr12.sdss3.org/spectrumDetail?mjd=' + mjds[i] + '&fiber=' + fibers[i] + '&plateid=' + plates[i]
	+ '">' + names[i] + '</a>';

	    circ._showLabelAdded = true;
	    circ.bindLabel(circ.name, { noHide: true, clickable: true });
	    circ.label._latlng = L.latLng(lat,lng);
	
	    circ.on('remove', function(e){
		console.log('Removing label for ' + e.target.name);
		map.removeLayer(e.target.label);
	    });
	}
        circleList[i] = circ;
    }
    circles = L.layerGroup(circleList);
    specGroup.addLayer(circles);
    if (showlabels) {
    	// show labels
    	for (i=0; i<circleList.length; i++) {
    	    circ = circleList[i];
    	    map.showLabel(circ.label);
    	}
    }

    // remove old layers
    for (var k in specLayers) {
	if (k < counter) {
	    console.log('spec: removing previous counter ' + k);
	    specGroup.removeLayer(specLayers[k]);
	    delete specLayers[k];
	} else {
	    console.log('spec: k ' + k + ' vs counter ' + counter);
	}
    }
    // save this new layer
    specLayers[counter] = [circles];
    console.log('spec: saved counter ' + counter);
}


function brightLoaded(counter, result) {
    console.log('brightLoaded: counter ' + counter);
    if (!showBright) {
        return;
    }
    for (var k in brightLayers) {
	if (k > counter) {
	    console.log('bright: counter ' + k + ' exists; bye');
	    return;
	}
    }
    for (var k in brightLayers) {
	console.log('bright: counter ' + k + ' exists');
    }

    rdlist = result['rd'];
    names = result['name'];
    altnames = result['altname'];

    showlabels = (map.getZoom() >= brightLabelsMinZoom);

    var circleList = new Array(rdlist.length);
    var clong = map.getCenter().lng;
    for (i=0, len=rdlist.length; i<len; i++) {
        r = rdlist[i][0];
        d = rdlist[i][1];
        lat = dec2lat(d);
        lng = ra2long_C(r, clong);

	// ~ 100 arcsec
	meters = 3000;
	color = '#ffffff';
        circ = L.circle([lat, lng], meters, {'color':color,
                                             'fillOpacity':0, 'weight':5});
        circ.ra = r;
        circ.dec = d;

	if (showlabels) {
        name = names[i];
        if (altnames[i].length > 0) {
            name = name + ' (' + altnames[i] + ')';
        }
	    circ.name = '<a href="http://simbad.u-strasbg.fr/simbad/sim-basic?Ident=' + names[i].replace(' ','+') + '">' + name + '</a>';
	    circ._showLabelAdded = true;
	    circ.bindLabel(circ.name, { noHide: true, clickable: true });
	    circ.label._latlng = L.latLng(lat,lng);
	
	    circ.on('remove', function(e){
		console.log('Removing label for ' + e.target.name);
		map.removeLayer(e.target.label);
	    });
	}
        circleList[i] = circ;
    }

    circles = L.layerGroup(circleList);

    // remove old layers
    for (var k in brightLayers) {
	if (k < counter) {
	    console.log('bright: removing previous counter ' + k);
	    brightGroup.removeLayer(brightLayers[k]);
	    delete brightLayers[k];

        console.log('bright: now brightGroup contains layers:', brightGroup.getLayers());

	} else {
	    console.log('bright: k ' + k + ' vs counter ' + counter);
	}
    }

    brightGroup.clearLayers();

    brightGroup.addLayer(circles);
    if (showlabels) {
    	// show labels
    	for (i=0; i<circleList.length; i++) {
    	    circ = circleList[i];
    	    map.showLabel(circ.label);
    	}
    }

    // save this new layer
    brightLayers[counter] = [circles];
    console.log('bright: saved counter ' + counter);
}





// Reads global "catname", name of catalog sources to load.
// and 'sourcesMinZoom'
function doLoadTile(tile) {
    if (!(showSources || showNgc)) {
	return;
    }
    //console.log('doLoadtile: ' + tile);

    s = getSubdomain(tile.tilex, tile.tiley);
    if (showSources && (tile.z >= sourcesMinZoom)) {
	caturl = L.Util.template('{{ caturl|safe }}', L.extend({
            s: s,
            z: tile.z,
            x: tile.tilex,
            y: tile.tiley,
            id: catname,
            ver: getcatversion(catname),
	}));
	console.log('Loading catalog version ' + catname);
	$.getJSON(caturl, catLoaded.bind(true,
					 tile.z, tile.tilex, tile.tiley));
    }
    if (showNgc) {
	url = L.Util.template('{{ caturl|safe }}', L.extend({
            s: s,
            z: tile.z,
            x: tile.tilex,
            y: tile.tiley,
            id: 'ngc',
            ver: getcatversion('ngc'),
	}));
	$.getJSON(url, ngcLoaded.bind(true,
				     tile.z, tile.tilex, tile.tiley));
    }
}

function onTileLoadStart(e) {
    tile = e.tile;
    key = '' + tile.z + ':' + tile.tilex + ':' + tile.tiley;
    if (key in visibleTiles) {
      console.log('onTileLoadStart: key ' + key + ' was already in visibleTiles');
      return;
    }
    visibleTiles[key] = tile;
    //console.log('onTileLoadStart: ' + key);
    doLoadTile(tile);
}

function doUnloadTile(key) {
    //console.log('doUnloadTile: ' + key);
    //if (!showSources) {
    if (key in catLayers) {
	circles = catLayers[key];
	if (typeof(circles) == 'undefined') {
	    console.log('doUnloadTile on a tile with no catalog; whatevs');
	} else {
	    sourcesGroup.removeLayer(circles);
	    delete catLayers[key];
	    console.log('remaining catalog layers: ' + getkeys(catLayers));
	}
    }
    //if (!showNgc) {
    if (key in ngcLayers) {
	circles = ngcLayers[key];
	if (typeof(circles) == 'undefined') {
	    console.log('doUnloadTile on a tile with no NGC; whatevs');
	} else {
	    ngcGroup.removeLayer(circles);
	    delete ngcLayers[key];
	    console.log('remaining NGC layers: ' + getkeys(ngcLayers));
	}
    }
}

function removeAllCatalogLayers() {
    for (key in catLayers) {
	console.log('removeAllCatalogLayers: removing ' + key);
	circles = catLayers[key];
	sourcesGroup.removeLayer(circles);
	delete catLayers[key];
    }

    sourcesGroup.clearLayers();
}

function removeAllSpecLayers() {
    for (key in specLayers) {
	console.log('removeAllSpecLayers: removing ' + key);
	circles = specLayers[key];
	specGroup.removeLayer(circles);
	delete specLayers[key];
    }

    //
    specGroup.clearLayers();

}

function removeAllBrightLayers() {
    for (key in brightLayers) {
	console.log('removeAllBrightLayers: removing ' + key);
	circles = brightLayers[key];
	brightGroup.removeLayer(circles);
	delete brightLayers[key];
    }

    //
    brightGroup.clearLayers();

}

function onTileUnload(e) {
    tile = e.tile;
    key = ''+tile.z+':'+tile.tilex+':'+tile.tiley;
    //console.log('onTileUnload: ' + key);
    delete visibleTiles[key];
    doUnloadTile(key);
}

function brick_detail(name) {
    return '<a href="{% url 'brick_detail_blank' %}' + name
        + '/">' + name + '</a>';
}

function ccd_detail(name, aparams) {
    return '<a href="{% url 'ccd_detail_blank' %}' + idname + '/' + name
        + '/"' + aparams + '>' + name + '</a>';
}

function exp_detail(name, aparams) {
    return '<a href="{% url 'exp_detail_blank' %}' + idname + '/' + name
        + '/"' + aparams + '>' + name + '</a>';
}

function onMapClick(e) {
    ra  = long2ra(e.latlng.lng);
    dec = lat2dec(e.latlng.lat);
    bricks = bricksUnderLatlng(e.latlng);
    ccds = ccdsUnderLatlng(e.latlng);
    exps = expsUnderLatlng(e.latlng);
    //'lat,lng =' + e.latlng.lat.toFixed(4) + ',' + e.latlng.lng.toFixed(4) + '; ' +
    //ra.toFixed(4) + ', ' + dec.toFixed(4) +
    txt = 
        'RA,Dec = ' + cutout_radec_link(ra, dec) +
        '<br/><a href="{{ baseurl }}ra=' + ra.toFixed(4) +
        '&dec=' + dec.toFixed(4) + '&zoom=' + map.getZoom() +
	'&layer=' + idname
        + '">link here</a>';
    if (bricks.length) {
        for (var i=0; i<bricks.length; i++) {
            txt += '<br/>Brick: ' + brick_detail(bricks[i]);
        }
    }
    if (ccds.length) {
        for (var i=0; i<ccds.length; i++) {
            txt += '<br/>CCD: ' + ccd_detail(ccds[i], '');
        }
    }
    if (exps.length) {
        for (var i=0; i<exps.length; i++) {
            txt += '<br/>Exposure: ' + exp_detail(exps[i], '');
        }
    }
    popup.setLatLng(e.latlng).setContent(txt).openOn(map);
}

function onMouseMove(e) {
    ra  = long2ra(e.latlng.lng);
    dec = lat2dec(e.latlng.lat);
    lastLatLng = e.latlng;
    if (infoBoxActive) {
	info._div.innerHTML = 'RA,Dec = ' + ra.toFixed(4) + ", " + dec.toFixed(4) + ", zoom " + map.getZoom();
	    //+ ', lat,long ' + e.latlng.lat.toFixed(3) + ',' + e.latlng.lng.toFixed(3);
    }
    if (inbrickccdAdded) {
        e.ra = ra;
        e.dec = dec;
        inbrickccdUpdate(e);
    }
}

function bricksUnderLatlng(latlng) {
    // Returns a list of the brick names under a given lat,long
    bricks = [];
    if (showBricks) {
        geos = [];
        for (var name in currentBricks) {
            brick = currentBricks[name];
            gj = brick.toGeoJSON();
            gj.properties['name'] = name;
            geos.push(gj);
        }
        geo = {type:'FeatureCollection', features:geos};
        leafgeo = L.geoJson(geo);
        inside = leafletPip.pointInLayer(latlng, leafgeo);
        for (var i=0; i<inside.length; i++) {
            bricks.push(inside[i].feature.properties.name);
        }
        bricks.sort();
    }
    return bricks;
}

function ccdsUnderLatlng(latlng) {
    ccds = [];
    if (showCcds) {
        geos = [];
        for (var name in currentCcds) {
            ccd = currentCcds[name];
            gj = ccd.toGeoJSON();
            gj.properties['name'] = name;
            geos.push(gj);
        }
        geo = {type:'FeatureCollection', features:geos};
        leafgeo = L.geoJson(geo);
        inside = leafletPip.pointInLayer(latlng, leafgeo);
        for (var i=0; i<inside.length; i++) {
            ccds.push(inside[i].feature.properties.name);
        }
        if (highlightedCcdName != '') {
            if (ccds.indexOf(highlightedCcdName) == -1) {
                ccds.push(highlightedCcdName);
            }
        }
        //ccds.sort();
    }
    return ccds;
}

function expsUnderLatlng(latlng) {
    exps = [];
    if (showExps) {
        for (var name in currentExps) {
            exp = currentExps[name];
	    if (latlng.distanceTo(exp.getLatLng()) < exp.getRadius()) {
		exps.push(exp.name);
	    }
        }
        if (highlightedExpName != '') {
            if (exps.indexOf(highlightedExpName) == -1) {
                exps.push(highlightedExpName);
            }
        }
    }
    return exps;
}

function inbrickccdUpdate(props) {
    if (props == undefined) {
        return;
    }
    bricks = bricksUnderLatlng(props.latlng);
    ccds = ccdsUnderLatlng(props.latlng);
    exps = expsUnderLatlng(props.latlng);
    txt = '';
    if (bricks.length || ccds.length || exps.length) {
        if (bricks.length) {
            txt = txt + 'In brick: ';
            for (var i=0; i<bricks.length; i++) {
                if (i) {
                    txt = txt + ', ';
                }
                txt = txt + brick_detail(bricks[i]);
            }
            if (ccds.length) {
                txt = txt + '<br/>';
            }
        }
        if (ccds.length) {
            txt = txt + 'In CCDs:<ul>';
            for (var i=0; i<ccds.length; i++) {
                ccdname = ccds[i];
                aparams = '';
                if (ccdname == highlightedCcdName) {
                    aparams = ' class="highccd"';
                }
                //ccdtext = ccdname;
                ccdtext = ccd_detail(ccdname, aparams);
                //ccdtext = '<div class="highccd">' + ccdtext + '</div>';
                //}
                txt = txt + '<li>'+ccdtext+'</li>';
            }
            txt = txt + '</ul>';
        }
        if (exps.length) {
            txt = txt + 'In Exposures:<ul>';
            for (var i=0; i<exps.length; i++) {
                expname = exps[i];
                aparams = '';
                if (expname == highlightedExpName) {
                    aparams = ' class="highexp"';
                }
                exptext = exp_detail(expname.replace(' ','-'), aparams);
                txt = txt + '<li>'+exptext+'</li>';
            }
            txt = txt + '</ul>';
        }
    }
    inbrickccd._div.innerHTML = txt;
}


var specCounter = 1;

function loadSpecCatalog() {
    b = map.getBounds();
    url = L.Util.template('{{ smallcaturl|safe }}', L.extend({
        s: subdomains[0],
	ralo: long2ra(b.getEast()).toFixed(4),
	rahi: long2ra(b.getWest()).toFixed(4),
	declo: lat2dec(b.getSouth()).toFixed(4),
	dechi: lat2dec(b.getNorth()).toFixed(4),
        id: 'spec',
        ver: getcatversion('spec'),
    }));
    console.log('Loading spectra for counter ' + specCounter);
    $.getJSON(url, specLoaded.bind(true, specCounter));
    specCounter += 1;
}

var brightCounter = 1;

function loadBrightCatalog() {
    b = map.getBounds();
    url = L.Util.template('{{ smallcaturl|safe }}', L.extend({
        s: subdomains[0],
	ralo: long2ra(b.getEast()).toFixed(4),
	rahi: long2ra(b.getWest()).toFixed(4),
	declo: lat2dec(b.getSouth()).toFixed(4),
	dechi: lat2dec(b.getNorth()).toFixed(4),
        id: 'bright',
        ver: getcatversion('bright'),
    }));
    console.log('Loading bright stars for counter ' + brightCounter);
    $.getJSON(url, brightLoaded.bind(true, brightCounter));
    brightCounter += 1;
}

// "Sources", "Bricks", "CCDs" button checked
function overlayAdded(e) {
    //console.log('OverlayAdded: ' + e.name);
    cat = false;
    ngc = false
    if (e.name == 'Sources') {
        showSources = true;
        cat = true;
    }
    if (e.name == ngcName) {
        showNgc = true;
        ngc = true;
    }
{% comment %}
    // other code moved to vcc.html
    if (e.name == vccName) {
        showVcc = true;
	loadVccCatalog();
    }
{% endcomment %}
    if (e.name == specName) {
	showSpec = true;
	if (map.getZoom() >= specMinZoom) {
	    loadSpecCatalog();
	}
    }
    if (e.name == brightName) {
	showBright = true;
	if (map.getZoom() >= brightMinZoom) {
	    loadBrightCatalog();
	}
    }

    if (cat || ngc) {
        // request catalogs for currently-visible tiles
        //console.log('Visible tiles: ' + visibleTiles);
        for (var i in visibleTiles) {
            doLoadTile(visibleTiles[i]);
        }
    }

    if (e.name == 'Bricks') {
        showBricks = true;
        mapBoundsChanged();
        // set initial 'in brick'
        //inbrickccdUpdate(e);
    }
    if (e.name == 'Exposures') {
        showExps = true;
        mapBoundsChanged();
    }
    if (e.name == 'SDSS Spectro Plates') {
        showPlates = true;
        mapBoundsChanged();
    }
    if (e.name == 'CCDs') {
        showCcds = true;
        mapBoundsChanged();
    }
    if (showBricks || showCcds || showExps || showPlates) {
        if (!inbrickccdAdded) {
            inbrickccd.addTo(map);
            inbrickccdAdded = true;
        }
    }
}

// "Sources", "Bricks", "CCDs" button unchecked
function overlayRemoved(e) {
    //console.log('OverlayRemoved: ' + e.name);
    unload = false;
    if (e.name == 'Sources') {
        showSources = false;
	unload = true;
    }
    if (e.name == ngcName) {
        showNgc = false;
	unload = true;
    }
{% comment %}
    if (e.name == vccName) {
        showVcc = false;
	for (var k in vccLayers) {
	    vccGroup.removeLayer(k);
	}
	vccLayers = {};
    }
{% endcomment %}
    if (e.name == specName) {
	showSpec = false;
	for (var k in specLayers) {
	    specGroup.removeLayer(k);
	}
	specLayers = {};
    }

    if (e.name == brightName) {
	showBright = false;
	for (var k in brightLayers) {
	    brightGroup.removeLayer(k);
	}
	brightLayers = {};
    }

    if (unload) {
        // remove all catalogs
        for (var i in visibleTiles) {
            doUnloadTile(i);
        }
    }

    if (e.name == 'Bricks') {
        showBricks = false;
        for (var i in currentBricks) {
            removeBrick(i);
        }
    }
    if (e.name == 'CCDs') {
        showCcds = false;
        for (var i in currentCcds) {
            removeCcd(i);
        }
        for (var name in ccdFills) {
            map.removeLayer(ccdFills[name]);
            delete ccdFills[name];
        }
    }
    if (e.name == 'Exposures') {
        showExps = false;
        for (var i in currentExps) {
            removeExp(i);
        }
        for (var name in expFills) {
            map.removeLayer(expFills[name]);
            delete expFills[name];
        }
    }

    if (!(showBricks || showCcds || showExps)) {
        if (inbrickccdAdded) {
            map.removeControl(inbrickccd);
            inbrickccdAdded = false;
        }
    }
}

function removeBrick(name) {
    brick = currentBricks[name];
    bricksGroup.removeLayer(brick);
    delete currentBricks[name];
}

function removeCcd(name) {
    ccd = currentCcds[name];
    ccdsGroup.removeLayer(ccd);
    delete currentCcds[name];
}

function removeExp(name) {
    exp = currentExps[name];
    expsGroup.removeLayer(exp);
    delete currentExps[name];
}

function removePlate(name) {
    exp = currentPlates[name];
    expsGroup.removeLayer(exp);
    delete currentPlates[name];
}

function bricksLoaded(result) {
    if (!showBricks) {
        return;
    }
    bricks = result['bricks'];
    var clong = map.getCenter().lng;
    for (var i=0, len=bricks.length; i<len; i++) {
        //console.log('brick ' + i + ': ' + bricks[i]);
        name = bricks[i].name;
        if (name in currentBricks) {
            //console.log('Brick ' + name + ' already exists');
            continue;
        }
        poly = bricks[i].poly;
        for (var j=0, npoly=poly.length; j<npoly; j++) {
            while (poly[j][1] < clong-180) { poly[j][1] += 360; }
            while (poly[j][1] > clong+180) { poly[j][1] -= 360; }
        }
        b = L.polygon(poly, {fill:false, weight:4, color:'blue' });
        b.name = name;
        //console.log('Adding brick ' + name + ': polygon ' + poly);
        bricksGroup.addLayer(b);
        currentBricks[name] = b;
    }
}

function unhighlightCcd(name) {
    map.removeLayer(ccdFills[name]);
    delete ccdFills[name];
}

function highlightCcd(ccd) {
    cf = L.polygon(ccd.getLatLngs(),
                   {fill:true, fillOpacity:0.05, color:'yellow', weight:1});
    ccdFills[ccd.name] = cf;
    cf.addTo(map);
    cf.bringToBack();
}

function ccdMouseOver(e) {
    e.target.setStyle({color: 'yellow'});
    ccd = e.target;
    highlightedCcdName = ccd.name;
    console.log('ccdMouseOver: ' + highlightedCcdName);
    // remove other CCDs from ccdFills
    for (var i=0; i<ccdFills.length; i++) {
        console.log('ccdMouseOver: ccd ' + ccd.name + '; ccdFills ' + ccdFills[i]);
        if (ccdFills[i] != ccd.name) {
            unhighlightCcd(ccdFills[i]);
        }
    }
    if (!(ccd.name in ccdFills)) {
        highlightCcd(ccd);
    }
    inbrickccdUpdate(e);
}

function ccdMouseOut(e) {
    e.target.setStyle({color: e.target.orig_color});
    ccd = e.target;
    highlightedCcdName = '';
    if (ccd.name in ccdFills) {
        unhighlightCcd(ccd.name);
    }
    inbrickccdUpdate(e);
}

function ccdsLoaded(result) {
    if (!showCcds) {
        return;
    }
    ccds = result['ccds'];
    console.log('Received ' + ccds.length + ' CCDs');
    var clong = map.getCenter().lng;
    console.log('Center long', clong);
    for (var i=0, len=ccds.length; i<len; i++) {
        // console.log('ccd ' + i + ': ' + ccds[i]);
        name = ccds[i].name;
        if (name in currentCcds) {
            //console.log('Ccd ' + name + ' already exists');
            continue;
        }
        poly = ccds[i].poly;
        for (var j=0, plen=poly.length; j<plen; j++) {
            // lng = poly[j][1];
            // wlng = wrap_long(lng, clong);
            // poly[j][1] = wlng;
            // console.log('ccd ' + i + ' poly ' + j + ' lng ' + lng + ' -> ' + wlng);
            poly[j][1] = wrap_long(poly[j][1], clong);
        }
        color = ccds[i].color;
        c = L.polygon(poly, {fill:false, color:color, weight:4 });
        c.orig_color = color;
        c.name = name;
        c.on('mouseover', ccdMouseOver);
        c.on('mouseout', ccdMouseOut);
        // console.log('Adding ccd ' + name + ': polygon ' + poly);
        ccdsGroup.addLayer(c);
        currentCcds[name] = c;
    }
}

function unhighlightExp(name) {
    map.removeLayer(expFills[name]);
    delete expFills[name];
}

function highlightExp(exp) {
    cf = L.circle(exp.getLatLng(), exp.getRadius(),
                  {fill:true, fillOpacity:0.05, color:'yellow', weight:1});
    expFills[exp.name] = cf;
    cf.addTo(map);
    cf.bringToBack();
}

function expsLoaded(result) {
    if (!showExps) {
        return;
    }
    exps = result['exposures'];
    console.log('Exposures:', exps.length);
    var clong = map.getCenter().lng;
    for (var i=0, len=exps.length; i<len; i++) {
        // console.log('exp ' + i + ': ' + exps[i]);
        name = exps[i].name;
        if (name in currentExps) {
            //console.log('Exp ' + name + ' already exists');
            continue;
        }
        lat = dec2lat(exps[i].dec);
        lng = ra2long_C(exps[i].ra, clong);


	meters = 30 * 3600 * exps[i].radius;
	color = exps[i].color;
	c = L.circle([lat,lng], meters, {'color':color, 'fillOpacity':0,
					 'weight':5, 'opacity':0.4 });
        c.name = name;
        expsGroup.addLayer(c);
        currentExps[name] = c;
    }
}

function platesLoaded(result) {
    if (!showPlates) {
        return;
    }
    plates = result['plates'];
    console.log('Plates:', plates.length);
    var clong = map.getCenter().lng;
    for (var i=0, len=plates.length; i<len; i++) {
        // console.log('plate ' + i + ': ' + plates[i]);
        name = plates[i].name;
        if (name in currentPlates) {
            //console.log('Plate ' + name + ' already exists');
            continue;
        }
        lat = dec2lat(plates[i].dec);
        lng = ra2long_C(plates[i].ra, clong);
	meters = 30 * 3600 * plates[i].radius;
	color = plates[i].color;
	c = L.circle([lat,lng], meters, {'color':color, 'fillOpacity':0,
					 'weight':5, 'opacity':0.4 });
        c.name = name;
        platesGroup.addLayer(c);
        currentPlates[name] = c;
    }
}


function mapBoundsChanged() {
    latlng = map.getCenter();
    zoom = map.getZoom();
    ra  = long2ra(latlng.lng);
    dec = lat2dec(latlng.lat);
    //console.log('map zoom: ' + zoom + ', RA,Dec ' + ra + ', ' + dec);

{% comment %}
    if (showVcc) {
        loadVccCatalog();
    }
{% endcomment %}

    if (showSpec && zoom > specMinZoom) {
        loadSpecCatalog();
    }
    if (showBright && zoom > brightMinZoom) {
        loadBrightCatalog();
    }

    if (showBricks) {
        bounds = map.getBounds();
        bricksurl = L.Util.template('{{ bricksurl|safe }}', L.extend({
            s: 'a',
            z: zoom,
            west:  long2ra(bounds.getWest()).toFixed(4),
            east:  long2ra(bounds.getEast()).toFixed(4),
            north: lat2dec(bounds.getNorth()).toFixed(4),
            south: lat2dec(bounds.getSouth()).toFixed(4),
            id: idname,
        }));
        $.getJSON(bricksurl, bricksLoaded);
    }
    if (showCcds) {
        bounds = map.getBounds();
        ccdsurl = L.Util.template('{{ ccdsurl|safe }}', L.extend({
            s: 'a',
            z: zoom,
            west:  long2ra(bounds.getWest()).toFixed(4),
            east:  long2ra(bounds.getEast()).toFixed(4),
            north: lat2dec(bounds.getNorth()).toFixed(4),
            south: lat2dec(bounds.getSouth()).toFixed(4),
            id: idname,
        }));
        $.getJSON(ccdsurl, ccdsLoaded);
    }
    if (showExps) {
        bounds = map.getBounds();
        expsurl = L.Util.template('{{ expsurl|safe }}', L.extend({
            s: 'a',
            z: zoom,
            west:  long2ra(bounds.getWest()).toFixed(4),
            east:  long2ra(bounds.getEast()).toFixed(4),
            north: lat2dec(bounds.getNorth()).toFixed(4),
            south: lat2dec(bounds.getSouth()).toFixed(4),
            id: idname,
        }));
        $.getJSON(expsurl, expsLoaded);
    }
    if (showPlates) {
        bounds = map.getBounds();
        platesurl = L.Util.template('{{ platesurl|safe }}', L.extend({
            s: 'a',
            z: zoom,
            west:  long2ra(bounds.getWest()).toFixed(4),
            east:  long2ra(bounds.getEast()).toFixed(4),
            north: lat2dec(bounds.getNorth()).toFixed(4),
            south: lat2dec(bounds.getSouth()).toFixed(4),
        }));
        $.getJSON(platesurl, platesLoaded);
    }

}

function onMapMoveEnd(e) {
    //console.log('Map move end.');
    mapBoundsChanged();
}

var inbrickccd = L.control();
inbrickccd.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'inbrickccd');
    this.update();
    return this._div;
};
inbrickccd.update = inbrickccdUpdate;
var inbrickccdAdded = false;

var showSources = false;
// "switchingSources" is only used when changing map base layers
// that have different catalogs; this requires some carefulness in
// the ordering of adding and removing layers.
var switchingSources = false;
var sourcesGroup = L.layerGroup([]);
var catLayers = {};
var visibleTiles = {};

var showNgc = false;
var ngcGroup = L.layerGroup([]);
var ngcLayers = {};

var showSpec = false;
var specGroup = L.layerGroup([]);
var specLayers = {};

var showBright = false;
var brightGroup = L.layerGroup([]);
var brightLayers = {};

var conGroup = L.layerGroup([]);

{% comment %}
var showVcc = false;
var vccGroup = L.layerGroup([]);
var vccLayers = {};
{% endcomment %}

var showBricks = false;
var bricksGroup = L.layerGroup([]);
var currentBricks = {};

var showCcds = false;
var ccdsGroup = L.layerGroup([]);
var currentCcds = {};
var ccdFills = {};
var highlightedCcdName = '';

var showExps = false;
var expsGroup = L.layerGroup([]);
var currentExps = {};
var expFills = {};
var highlightedExpName = '';

var showPlates = false;
var platesGroup = L.layerGroup([]);
var currentPlates = {};
var plateFills = {};
var highlightedPlateName = '';

var map = L.map('map');
var popup = L.popup();

// default to 1.
var tileversions = {
  'decals-wl':4,
  'decals-dr2':2,
};
var catversions  = {
  'decals-dr2': 2,
};

function getversion(layer) {
    if (layer in tileversions) {
        return tileversions[layer];
    }
    return 1;
}

function getcatversion(layer) {
    if (layer in catversions) {
        return catversions[layer];
    }
    return 1;
}

var idname = '{{ layer }}';
var catname = 'decals-dr1j';

var minZoom = 1;
var maxZoom = 16;

allLayers = [];

static_tile_url = '{{ static_tile_url|safe }}';


tilesSfd = new ZoomRangeTileLayer(static_tile_url, {
    maxZoom: maxZoom,
    minZoom: minZoom,
    maxNativeZoom: 10,
    attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
    id: 'sfd-tiles',
    ver: getversion('sfd'),
    unloadInvisibleTiles: true,
    subdomains: subdomains,
    urlPatterns: [ [7, 10, '{{ tileurl|safe }}'],],
  });
tilesSfd.on('tileloadstart', onTileLoadStart);
tilesSfd.on('tileunload', onTileUnload);

tilesHalpha = new ZoomRangeTileLayer(static_tile_url, {
    maxZoom: maxZoom,
    minZoom: minZoom,
    maxNativeZoom: 10,
    attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
    id: 'halpha-tiles',
    ver: getversion('halpha'),
    unloadInvisibleTiles: true,
    subdomains: subdomains,
    urlPatterns: [ [7, 10, '{{ tileurl|safe }}'],],
  });
tilesHalpha.on('tileloadstart', onTileLoadStart);
tilesHalpha.on('tileunload', onTileUnload);

function createStaticTileLayer(id, vertag) {
    var tiles = new MyTileLayer(static_tile_url, {
        maxZoom: maxZoom,
        minZoom: minZoom,
        attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
        id: id,
        ver: getversion(vertag),
        // ?
        unloadInvisibleTiles: true,
        subdomains: subdomains,
    });
    tiles.on('tileloadstart', onTileLoadStart);
    tiles.on('tileunload',    onTileUnload);
    return tiles;
}


{% if enable_dr2 %}
id = 'decals-dr2'
catname = 'decals-dr2';

// Use the static URL until zoom level 14, then the dynamic URL.
tiles = new ZoomRangeTileLayer(static_tile_url, {
    maxZoom: maxZoom,
    maxNativeZoom: {{ maxNativeZoom }},
    minZoom: minZoom,
    attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
    id: id,
    ver: getversion(id),
    unloadInvisibleTiles: true,
    subdomains: subdomains,
    urlPatterns: [ [14, 16, '{{ tileurl|safe }}'], ],
  });
tiles.catname = catname;
allLayers.push({name:id, tiles:tiles, pretty:"DECaLS DR2 images", catname:catname});


id = 'decals-dr2-model'
tiles = new ZoomRangeTileLayer(static_tile_url, {
    maxZoom: maxZoom,
    maxNativeZoom: {{ maxNativeZoom }},
    minZoom: minZoom,
    attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
    id: id,
    ver: getversion(id),
    unloadInvisibleTiles: true,
    subdomains: subdomains,
    urlPatterns: [ [14, 16, '{{ tileurl|safe }}'], ],
  });
tiles.catname = catname;
allLayers.push({name:id, tiles:tiles, pretty:"DECaLS DR2 models", catname:catname});

id = 'decals-dr2-resid'
tiles = new ZoomRangeTileLayer(static_tile_url, {
    maxZoom: maxZoom,
    maxNativeZoom: {{ maxNativeZoom }},
    minZoom: minZoom,
    attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
    id: id,
    ver: getversion(id),
    unloadInvisibleTiles: true,
    subdomains: subdomains,
    urlPatterns: [ [14, 16, '{{ tileurl|safe }}'], ],
  });
tiles.catname = catname;
allLayers.push({name:id, tiles:tiles, pretty:"DECaLS DR2 residuals", catname:catname});



{% endif %}





id = 'decals-dr1j'
catname = 'decals-dr1j';

// Use the static URL until zoom level 14, then the dynamic URL.
tilesDr1j = new ZoomRangeTileLayer(static_tile_url, {
    maxZoom: maxZoom,
    maxNativeZoom: {{ maxNativeZoom }},
    minZoom: minZoom,
    attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
    id: id,
    ver: getversion(id),
    unloadInvisibleTiles: true,
    subdomains: subdomains,
    urlPatterns: [ [14, 16, '{{ tileurl|safe }}'], ],
  });

tilesDr1j.catname = catname;
allLayers.push({name:id, tiles:tilesDr1j, pretty:"DECaLS DR1 images", catname:catname});

id = 'decals-model-dr1j'
tilesModDr1j = new ZoomRangeTileLayer(static_tile_url, {
    maxZoom: maxZoom,
    maxNativeZoom: {{ maxNativeZoom }},
    minZoom: minZoom,
    attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
    id: id,
    ver: getversion(id),
    unloadInvisibleTiles: true,
    subdomains: subdomains,
    urlPatterns: [ [14, 16, '{{ tileurl|safe }}'], ],
  });

tilesModDr1j.catname = catname;
allLayers.push({name:id, tiles:tilesModDr1j, pretty:"DECaLS DR1 models", catname:catname});

id = 'decals-resid-dr1j'
tilesResidDr1j = new ZoomRangeTileLayer(static_tile_url, {
    maxZoom: maxZoom,
    maxNativeZoom: {{ maxNativeZoom }},
    minZoom: minZoom,
    attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
    id: id,
    ver: getversion(id),
    unloadInvisibleTiles: true,
    subdomains: subdomains,
    urlPatterns: [ [14, 16, '{{ tileurl|safe }}'], ],
  });

tilesResidDr1j.catname = catname;
allLayers.push({name:id, tiles:tilesResidDr1j, pretty:"DECaLS DR1 residuals", catname:catname});

id = 'sdssco'
tiles = new ZoomRangeTileLayer(static_tile_url, {
    maxZoom: maxZoom,
    maxNativeZoom: {{ maxNativeZoom }},
    minZoom: minZoom,
    attribution: '<a href="http://sdss.org">SDSS</a>',
    id: id,
    ver: getversion(id),
    unloadInvisibleTiles: true,
    subdomains: subdomains,
    urlPatterns: [ [14, 16, '{{ tileurl|safe }}'], ],
  });
allLayers.push({name:id, tiles:tiles, pretty:"SDSS images", catname:""});

allLayers.push({name:'sfd', tiles:tilesSfd, pretty:"SFD dust map", catname:""});

allLayers.push({name:'halpha', tiles:tilesHalpha, pretty:"Halpha map", catname:""});


{% if enable_wl %}

tilesWl = new ZoomRangeTileLayer('{{ tileurl|safe }}', {
    maxZoom: maxZoom,
    minZoom: minZoom,
    maxNativeZoom: 10,
    attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
    id: 'decals-wl',
    ver: getversion('decals-wl'),
    unloadInvisibleTiles: true,
    subdomains: subdomains,
    //urlPatterns: [ [7, 10, '{{ tileurl|safe }}'],],
  });
tilesWl.on('tileloadstart', onTileLoadStart);
tilesWl.on('tileunload', onTileUnload);

allLayers.push({name:'decals-wl', tiles:tilesWl, pretty:"DECaLS DR1 Weak Lensing map", catname:""});

{% endif %}

{% if enable_depth %}
bands = ['g','r','z'];
for (var i in bands) {
    band = bands[i];
    tilesDepth = new ZoomRangeTileLayer('{{ tileurl|safe }}?band=' + band, {
	maxZoom: maxZoom,
	minZoom: minZoom,
	attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
	id: 'decam-depth',
	ver: getversion('decam-depth'),
	unloadInvisibleTiles: true,
	subdomains: subdomains,
	//urlPatterns: [ [7, 10, '{{ tileurl|safe }}'],],
    });
    tilesDepth.on('tileloadstart', onTileLoadStart);
    tilesDepth.on('tileunload', onTileUnload);
    allLayers.push({name:'decam-depth-'+band, tiles:tilesDepth, pretty:"DECam Depth: " + band + " band", catname:""});
}
{% endif %}

id = 'unwise-w1w2-tiles'
vertag = 'unwise'
tilesUnwise = new MyTileLayer('{{ tileurl|safe }}', {
      maxZoom: maxZoom,
      //maxNativeZoom: 11,
      maxNativeZoom: 10,
      minZoom: minZoom,
      attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
      id: id,
      ver: getversion(vertag),
      unloadInvisibleTiles: true,
      subdomains: subdomains,
});

allLayers.push({name:'unwise', tiles:tilesUnwise, pretty:"unWISE W1/W2", catname:""});



{% comment %}

if (idname == 'unwise') {
  id = 'unwise-w3w4-tiles'
  vertag = 'unwise'
  tilesUnwise = new MyTileLayer('{{ tileurl|safe }}', {
        maxZoom: maxZoom,
        maxNativeZoom: 11,
        minZoom: minZoom,
        attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
        id: id,
        ver: getversion(vertag),
        unloadInvisibleTiles: true,
        subdomains: subdomains,
  });

  allLayers.push({name:'unwise-w3w4', tiles:tilesUnwise, pretty:"unWISE W3/W4", catname:""});
}

if (idname == 'unwise') {
  id = 'unwise-w1234-tiles'
  vertag = 'unwise'
  tilesUnwise = new MyTileLayer('{{ tileurl|safe }}', {
        maxZoom: maxZoom,
        maxNativeZoom: 11,
        minZoom: minZoom,
        attribution: '<a href="http://legacysurvey.org">DECaLS</a>',
        id: id,
        ver: getversion(vertag),
        unloadInvisibleTiles: true,
        subdomains: subdomains,
  });

  allLayers.push({name:'unwise-w3w4', tiles:tilesUnwise, pretty:"unWISE W1234", catname:""});
}

{% endcomment %}


var baseMaps = {};
for (i in allLayers) {
  layer = allLayers[i];

  tiles = layer.tiles;
  tiles.on('tileloadstart', onTileLoadStart);
  tiles.on('tileunload', onTileUnload);

  tiles.name = layer.name;

  baseMaps[layer.pretty] = tiles;
}

added = false;
for (i in allLayers) {
  layer = allLayers[i];
  if (idname == layer.name) {
    layer.tiles.addTo(map);
    added = true;
    if (layer.catname.length > 0) {
      catname = layer.catname;
    }
  }
}
if (!added) {
  tilesDr1j.addTo(map);
}

function doGoto() {
    ra  = $('#gotora').val();
    dec = $('#gotodec').val();
    zoom = $('#gotozoom').val();
    console.log('RA ' + ra + ', Dec ' + dec + ', Zoom ' + zoom);
    ra = parseFloat(ra);
    dec = parseFloat(dec);
    zoom = parseInt(zoom);
    console.log('RA ' + ra + ', Dec ' + dec + ', Zoom ' + zoom);
    map.setView(L.latLng(dec2lat(dec), ra2long_C(ra, 0)), zoom);
}

function submitGoto(e) {
    console.log('submit goto ' + typeof(e) + getkeys(e));
    e.stopPropagation();
    doGoto();
}

function cancelGoto(e) {
    console.log('cancel goto ' + typeof(e));
    infoBoxActive = true;
    onMouseMove({ latlng: map.getCenter() });
    e.stopPropagation();
}

function gotoKeypress(e) {
    if (e.which == 13) {
	// Enter key
	doGoto();
    }
}

function infoBoxClicked(e) {
    console.log('Info box clicked');
    if (!infoBoxActive) {
	return;
    }
    infoBoxActive = false;
    ra  = long2ra(map.getCenter().lng);
    dec = lat2dec(map.getCenter().lat);
    ra = ra.toFixed(4);
    // trim trailing zeros
    while (ra.length && ra.charAt(ra.length-1) == '0') {
	ra = ra.substring(0, ra.length-1);
    }
    dec = dec.toFixed(4);
    while (dec.length && dec.charAt(dec.length-1) == '0') {
	dec = dec.substring(0, dec.length-1);
    }

    info._div.innerHTML = '<center><form>RA,Dec '
	+ '<input name="ra"  id="gotora"  value="' + ra
	+ '" size=6>, '
	+ '<input name="dec" id="gotodec" value="' + dec
	+ '" size=6>, '
	+ 'zoom <input name="zoom" id="gotozoom" value="' + map.getZoom() + '" size=4>'
	+ '<br/><br/>'
	+ '<input type="button" value="Go" id="gotosubmit">'
	+ '<input type="button" value="Cancel" id="gotocancel">'
	+ '</form></center>';
    $('#gotosubmit').click(submitGoto);
    $('#gotocancel').click(cancelGoto);
    $('#gotora').keypress(gotoKeypress);
    $('#gotodec').keypress(gotoKeypress);
    $('#gotozoom').keypress(gotoKeypress);
}

var infoBoxActive = true;
var info = L.control();
info.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'info');
    this._div.innerHTML = 'RA,Dec = ' + {{ra}}.toFixed(4) + ", " + {{dec}}.toFixed(4) + ", zoom " + {{zoom}};
    return this._div;
};
info.addTo(map);

container = info.getContainer();
L.DomEvent
  .disableClickPropagation(container)
  .disableScrollPropagation(container);
L.DomEvent.on(container, 'click', infoBoxClicked);

//var vccName = "Virgo clusters";
var specName = "Spectra";
var ngcName = "NGC galaxies";
var brightName = "Bright stars";

var overlayMaps = {
    "Sources": sourcesGroup,
    "Bricks": bricksGroup,
    "CCDs": ccdsGroup,
    "Exposures": expsGroup,
};
overlayMaps[ngcName] = ngcGroup;
overlayMaps[brightName] = brightGroup;
overlayMaps[specName] = specGroup;
overlayMaps["SDSS Spectro Plates"] = platesGroup;

{% comment %}
    "Constellations": conGroup,
{% endcomment %}

{% if enable_vcc %}
overlayMaps[vccName] = vccGroup;
{% endif %}

new MyLayerControl(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

function onMapPreBaseLayerChange(e) {
    console.log('PRE Map base layer change');
    console.log('removing: catalog name: ' + e.removing.catname);
    console.log('adding: catalog name: ' + e.adding.catname);
    if ((typeof(e.adding.catname)   == 'undefined') ||
        (typeof(e.removing.catname) == 'undefined')) {
        return;
    }
    if (!showSources) {
        catname = e.adding.catname;
        return;
    }
    if (e.removing.catname == e.adding.catname) {
        return;
    }
    console.log('Removing sources');
    switchingSources = true;
    overlayRemoved({name:'Sources'});
    catname = e.adding.catname;
    console.log('Switched catalog name to ' + catname);
}

function onMapPostBaseLayerChange(e) {
    console.log('POST Map base layer change');
    console.log('removing: catalog name: ' + e.removing.catname);
    console.log('adding: catalog name: ' + e.adding.catname);

    if (typeof(e.adding.name) != 'undefined') {
      idname = e.adding.name;
      console.log('Layer name: ' + e.adding.name);
    }

    if ((e.adding.catname == undefined) || (e.removing.catname == undefined)) {
        return;
    }
    if (!switchingSources || (e.removing.catname == e.adding.catname)) {
        return;
    }
    console.log('Re-adding sources');
    overlayAdded({name:'Sources'});
}


/*
The overlays DOM looks like this:

<div class="leaflet-control-layers-overlays">
  <label>
    <input class="leaflet-control-layers-selector" type="checkbox">
    <span> Sources</span>
  </label>
  <label>
    <input class="leaflet-control-layers-selector" type="checkbox">
    <span> Bricks</span>
  </label>
  <label>
</div>
*/
// We iterate through the <input> tags, getting the text from the next sibling.
function getOverlayCheckbox(name) {
  var ov = false;
  overlays = $('.leaflet-control-layers-overlays .leaflet-control-layers-selector');
  overlays.each(function(i) {
    o = $(this);
    text = $.trim(o.next().text());
    if (text == name) {
      ov = o;
    }
  });
  return ov;
}
function isOverlayChecked(name) {
  o = getOverlayCheckbox(name);
  return $(o).prop('checked');
}
function setOverlayEnabled(name, enabled) {
  o = getOverlayCheckbox(name);
  if (enabled) {
    o.removeAttr('disabled');
  } else {
    o.attr('disabled', 'disabled');
  }
}

//
var bricksMinZoom = 8;
var ccdsMinZoom = 8;
var sourcesMinZoom = 12;
var ngcLabelsMinZoom = 8;

var specMinZoom = 10;
var specLabelsMinZoom = 11;

var brightMinZoom = 3;
var brightLabelsMinZoom = 6;

// variable for tracking old & new zoom via zoomstart / zoomend
var oldZoom = {{ zoom }};
function onMapZoomStart(e) {
  zoom = map.getZoom();
  console.log('map zoom start: ' + zoom + ', previous' + oldZoom);
  oldZoom = zoom;

}
function onMapZoomEnd(e) {
  zoom = map.getZoom();
  //console.log('map zoom: ' + zoom + ', old zoom' + oldZoom + ' vs brick zoom', bricksMinZoom);

  // Bricks

  if ((oldZoom >= bricksMinZoom) && (zoom < bricksMinZoom)) {
    // zoomed out past the boundary
    console.log('zoomed out past brick boundary');
    if (showBricks) {
      console.log('removing brick outlines');
      overlayRemoved({name:'Bricks'});
    }
    setOverlayEnabled('Bricks', false);
  } else if ((oldZoom < bricksMinZoom) && (zoom >= bricksMinZoom)) {
    // zoomed in past the boundary
    console.log('zoomed in past boundary');
    setOverlayEnabled('Bricks', true);
    if (isOverlayChecked('Bricks')) {
      console.log('Re-adding bricks');
      overlayAdded({name:'Bricks'});
    }
  }

  // CCDs

  if ((oldZoom >= ccdsMinZoom) && (zoom < ccdsMinZoom)) {
    console.log('zoomed out past CCD boundary');
    if (showCcds) {
      console.log('removing CCD outlines');
      overlayRemoved({name:'CCDs'});
    }
    setOverlayEnabled('CCDs', false);
  } else if ((oldZoom < ccdsMinZoom) && (zoom >= ccdsMinZoom)) {
    console.log('zoomed in past boundary');
    setOverlayEnabled('CCDs', true);
    if (isOverlayChecked('CCDs')) {
      console.log('Re-adding ccds');
      overlayAdded({name:'CCDs'});
    }
  }

  // Sources

  if ((oldZoom >= sourcesMinZoom) && (zoom < sourcesMinZoom)) {
    console.log('zoomed out past sources boundary');
    if (showSources) {
      console.log('removing sources');
      // By the time we get here, onTileUnload() has already fired.
      showSources = false;

      // remove any extra ones that have stuck around (fast zoom-outs)
      removeAllCatalogLayers();

    }
    setOverlayEnabled('Sources', false);
  } else if ((oldZoom < sourcesMinZoom) && (zoom >= sourcesMinZoom)) {
    console.log('zoomed in past boundary');
    setOverlayEnabled('Sources', true);
    if (isOverlayChecked('Sources')) {
      console.log('Re-adding sources');
      overlayAdded({name:'Sources'});
    }
  }


  // Spectra

  if ((oldZoom >= specMinZoom) && (zoom < specMinZoom)) {
    console.log('zoomed out past spec boundary');
    if (showSpec) {
      console.log('removing spec');
      // By the time we get here, onTileUnload() has already fired.
      showSpec = false;

      // remove any extra ones that have stuck around (fast zoom-outs)
      removeAllSpecLayers();

    }
    setOverlayEnabled(specName, false);
  } else if ((oldZoom < specMinZoom) && (zoom >= specMinZoom)) {
    console.log('zoomed in past boundary');
    setOverlayEnabled(specName, true);
    if (isOverlayChecked(specName)) {
      console.log('Re-adding spec');
      overlayAdded({name:specName});
    }
  }


  // Bright stars

  if ((oldZoom >= brightMinZoom) && (zoom < brightMinZoom)) {
    console.log('zoomed out past bright boundary');
    if (showBright) {
      console.log('removing bright');
      // By the time we get here, onTileUnload() has already fired.
      showBright = false;

      // remove any extra ones that have stuck around (fast zoom-outs)
      removeAllBrightLayers();

    }
    setOverlayEnabled(brightName, false);
  } else if ((oldZoom < brightMinZoom) && (zoom >= brightMinZoom)) {
    console.log('zoomed in past boundary');
    setOverlayEnabled(brightName, true);
    if (isOverlayChecked(brightName)) {
      console.log('Re-adding bright');
      overlayAdded({name:brightName});
    }
  }




  // update the RA,Dec,zoom info box
  //console.log('last latlng: ' + lastLatLng);
  if (typeof(lastLatLng) != 'undefined') {
    onMouseMove({ latlng: lastLatLng });
  }


  oldZoom = zoom;

}

map.on('mousemove', onMouseMove);
map.on('overlayadd', overlayAdded);
map.on('overlayremove', overlayRemoved);
map.on('click', onMapClick);
map.on('moveend', onMapMoveEnd);
map.on('prebaselayerchange', onMapPreBaseLayerChange);
map.on('postbaselayerchange', onMapPostBaseLayerChange);
map.on('zoomstart', onMapZoomStart);
map.on('zoomend', onMapZoomEnd);

map.setView([ {{ lat }}, {{ long }}], {{ zoom }});

//var lastRaDec = [ long2ra({{long}}), lat2dec({{lat}}) ];
var lastLatLng = map.getCenter();

{% if showBricks %}
map.addLayer(bricksGroup);
overlayAdded({name:'Bricks'});
{% endif %}

{% if showCcds %}
console.log('addLayer(ccds)');
map.addLayer(ccdsGroup);
console.log('done addLayer(ccds)');
overlayAdded({name:'CCDs'});
{% endif %}

{% if showExps %}
console.log('addLayer(exps)');
map.addLayer(expsGroup);
console.log('done addLayer(exps)');
overlayAdded({name:'Exposures'});
{% endif %}

{% if showSources %}
map.addLayer(sourcesGroup);
// If you do this, you get double-adding!
//overlayAdded({name:'Sources'});
showSoures = true;
{% endif %}

{% if showNgc %}
map.addLayer(ngcGroup);
showNgc = true;
{% endif %}

{% comment %}
{% if showVcc %}
map.addLayer(vccGroup);
showVcc = true;
{% endif %}
{% endcomment %}

{% if showSpec %}
map.addLayer(specGroup);
showSpec = true;
{% endif %}

{% comment %}
var constellation_shortnames =  [ "Aql","And","Scl","Ara","Lib","Cet","Ari","Sct","Pyx","Boo","Cae","Cha","Cnc","Cap","Car","Cas","Cen","Cep","Com","Cvn","Aur","Col","Cir","Crt","CrA","CrB","Crv","Cru","Cyg","Del","Dor","Dra","Nor","Eri","Sge","For","Gem","Cam","CMa","UMa","Gru","Her","Hor","Hya","Hyi","Ind","Lac","Mon","Lep","Leo","Lup","Lyn","Lyr","Ant","Mic","Mus","Oct","Aps","Oph","Ori","Pav","Peg","Pic","Per","Equ","CMi","LMi","Vul","UMi","Phe","Psc","PsA","Vol","Pup","Ret","Sgr","Sco","Ser","Sex","Men","Tau","Tel","Tuc","Tri","Tra","Aqr","Vir","Vel" ]

var constellation_lines = [
    [8,5,3,7,5,20,3,5,2,9,2,2,5,9,14,4,16,6,2,1,6,6,2,9,9,6,6,2,9,5,5,14,5,27,4,1,16,5,17,19,9,18,2,18,4,3,6,6,14,10,13,7,5,1,2,4,3,2,7,21,13,13,2,10,4,1,4,1,7,11,19,6,7,7,4,24,12,11,1,1,12,1,3,3,3,14,12,10,],
    [582,579,579,576,579,568,568,580,591,580,568,555,555,551,568,556],
    [0,11,11,24,47,24,24,17,17,15],
    [685,18,18,681,681,685],
    [516,496,496,480,480,475,475,494,494,491,491,490,490,516],
    [444,432,432,419,419,412,412,416,416,432],
    [50,57,35,13,13,4,13,23,23,27,27,37,37,55,55,62,62,68,68,59,59,35,53,62,53,61,61,67,67,78,78,77,77,69,69,57,57,60,60,67],
    [72,48,48,43,43,39],
    [537,538,538,542,542,529,529,531,531,537],
    [256,261,261,267],
    [404,395,395,408,408,418,418,415,415,400,400,399,399,395,395,387,387,384],
    [120,126,126,127],
    [248,314,314,352],
    [264,260,260,249,260,262,262,247,262,269],
    [592,593,593,611,611,619,619,625,625,630,619,622,622,611,593,603,611,608],
    [277,302,302,316,316,317,317,325,325,321,321,311,311,305,305,279,258,250,250,197,276,279,276,258,197,203,250,242],
    [42,28,28,16,16,12,12,1],
    [403,391,391,382,382,388,388,389,389,386,386,385,385,380,380,377,385,393,386,401,401,414,388,365,365,356,356,346,346,335,335,336],
    [642,666,666,623,623,617,617,642,666,686,686,623],
    [374,375,375,355],
    [362,371],
    [180,179,179,148,148,140,140,138,153,138,153,180],
    [193,190,190,177,177,171,171,178,171,163,163,155],
    [406,425,406,420],
    [322,327,327,332,332,330,330,322,330,331,331,337,337,345,345,338,338,332],
    [534,546,546,549,549,557,557,560,560,561,561,559,559,553,553,545,534,530],
    [428,427,427,429,429,434,434,439,439,447,447,451],
    [359,357,357,351,351,348,348,347,348,363,363,357],
    [358,354,368,349],
    [563,570,570,575,575,594,594,600,594,604,604,613,613,627,594,583,583,571],
    [596,597,597,599,599,605,605,601,601,597],
    [166,173,173,159,159,166,159,121,121,111],
    [511,513,513,492,492,498,498,511,511,562,562,578,578,522,522,482,482,462,462,452,452,426,426,392,392,361,361,333],
    [456,460,460,463,463,453,453,460,453,456],
    [33,44,44,52,52,56,56,64,64,66,66,76,76,87,87,99,99,101,101,113,113,116,116,122,122,97,97,92,92,86,86,79,79,70,70,75,75,85,85,91,91,94,94,124,124,130,130,134,134,142,142,143,143,125],
    [574,577,577,573,577,584,584,589],
    [71,84],
    [202,219,219,228,228,227,227,206,228,235,235,239,235,240,235,230,230,222,222,234,222,210,222,204,204,199,204,195,195,189,189,183],
    [90,104,104,136,90,102,102,136,102,151],
    [211,218,218,213,213,205,205,217,217,220,220,224,224,229,215,216,216,220,216,212,212,201,201,200,201,194,201,205,215,208,192,215,213,211],
    [383,378,378,369,369,350,350,324,324,323,323,344,344,350,344,341,341,326,326,306,326,308,323,293,293,288,288,273,288,270,293,291,291,253,253,286,286,324],
    [675,650,650,638,638,659,659,677,677,675,659,672,659,664,638,635,635,632],
    [503,512,512,489,489,487,487,486,486,471,471,467,467,459,459,443,471,470,470,465,465,461,470,481,481,493,493,485,508,514,514,517,514,508,481,486],
    [109,65,65,80],
    [259,255,255,254,254,265,265,266,266,259,266,268,268,278,278,287,287,284,284,283,283,292,292,301,301,309,309,319,319,334,334,343,343,373,373,376],
    [7,98,98,63,63,54,54,45],
    [618,598,598,609,609,618],
    [643,652,652,651,651,648,648,647,647,654,654,651],
    [188,198,198,223,223,196,196,186,223,245,245,237],
    [184,176,176,167,167,158,158,145,158,172,172,165,165,154,154,141,158,154,145,149,145,146,141,145,146,144,149,150],
    [342,329,329,300,300,297,297,307,307,328,328,342,307,304,304,294,294,290,328,329],
    [442,455,455,449,449,442,449,431,431,423,423,424,423,413,431,433,433,417,417,405,417,402,405,397,405,413],
    [281,280,280,274,274,271,271,251,251,231,231,214,214,191],
    [532,535,535,539,539,550,550,541,541,535],
    [310,296],
    [616,610,610,607],
    [367,339,339,360,360,364,364,367],
    [626,661,661,398,398,626],
    [410,466,466,472],
    [500,506,483,506,500,479,479,458,458,469,469,483,483,495],
    [164,161,161,157,182,187,187,185,185,174,187,181,181,175,175,164,164,169,169,147,147,157,157,152,152,160,160,175,152,131,131,133,133,135,135,139,131,132,132,137,185,181],
    [595,621,621,602,602,590,590,595,590,586,586,533,533,547,547,590,547,540,540,524,524,518,518,540,518,507],
    [3,674,673,660,660,639,673,667,667,662,662,637,637,629,674,663,663,658,658,641,641,628,0,673,0,3],
    [207,170,170,168],
    [96,103,103,107,107,105,105,93,93,88,88,81,81,74,88,83,83,82,82,73],
    [612,614,614,620,620,615,615,612],
    [236,232],
    [320,312,312,298,298,289,298,320],
    [569,587],
    [58,497,497,473,473,435,435,457,457,422,422,411,411,435],
    [22,21,21,8,8,22,21,31,31,41,41,21,21,29,29,8,8,9,9,2,2,8],
    [19,25,19,26,26,25,25,32,32,36,36,46,46,40,40,34,34,30,30,20,20,14,14,6,6,689,689,687,687,688,688,683,683,679,679,684,684,687],
    [671,657,657,633,633,631,631,640,640,655,655,670],
    [238,221,221,244,244,238,244,225,244,252,252,272,272,244],
    [243,241,241,226,226,203,203,209,209,233,233,242,242,243],
    [110,112,112,106,106,95,95,110],
    [521,527,520,525,525,515,515,509,515,521,521,525,525,552,552,536,536,521,536,527,527,519,552,558,558,543,543,536,543,548,548,554,554,564,564,565,558,572,572,588,588,585,585,581,581,567,581,566],
    [499,505,505,510,510,501,501,484,484,478,478,477,477,476,476,468,468,464,464,450,464,448,464,454],
    [440,441,441,436,436,430,430,437,437,446,446,438,438,437,544,523,523,504,504,502,502,488],
    [313,299],
    [156,129],
    [153,128,128,118,123,162,114,115,114,108,108,89,123,118,123,119,119,114,118,117,117,115,115,100],
    [528,526],
    [645,680,680,5,680,10],
    [51,49,49,38,38,51],
    [474,421,421,445,445,474],
    [624,634,634,646,646,649,649,656,656,668,668,678,678,682,634,644,644,636,644,653,653,665,665,669,669,676,606,624],
    [340,353,353,366,366,379,379,394,394,396,396,407,379,381,381,390,390,409,381,370,370,372,370,366],
    [246,257,257,263,263,282,282,295,295,318,318,315,315,303,303,285,285,275,275,246]];

var constellation_stars = [2.09654,29.0908,2.29204,59.1502,2.35225,-45.747,3.30896,15.1836,4.857,-8.82383,5.00796,-64.8776,5.14942,8.19025,6.41333,-77.255,6.5505,-43.6799,6.57029,-42.3051,7.88567,-62.9581,9.83167,30.8612,10.1266,56.5374,10.8968,-17.9867,12.0722,7.29992,12.4535,41.0789,14.1771,60.7168,14.1879,38.4992,14.6515,-29.3575,15.7045,31.8043,15.7361,7.89008,16.5213,-46.7185,17.0961,-55.2458,17.1469,-10.1819,17.4325,35.6208,18.4373,24.5838,19.8666,27.2641,21.006,-8.18275,21.4525,60.2354,22.0914,-43.3177,22.5456,6.14394,22.8124,-49.0731,22.8708,15.3458,24.4281,-57.2367,25.358,5.48761,26.0214,-15.9396,26.3483,9.15764,27.865,-10.3349,28.2704,29.5794,28.3824,19.2941,28.3889,3.18747,28.4117,-46.3024,28.5987,63.6701,28.6598,20.8083,28.9868,-51.6096,29.6911,-61.5699,30.5117,2.76375,30.9747,42.3299,31.7929,23.4628,32.3855,34.9874,33.25,8.84675,33.9846,33.359,34.1271,-51.5121,34.8366,-2.97706,35.4376,-68.6594,36.4875,-12.2904,36.7462,-47.7038,37.0397,8.46008,37.9462,89.2641,38.022,-15.2443,38.9687,5.59331,39.8706,0.328528,39.8905,-11.8716,39.8968,-68.2669,39.9497,-42.8916,40.1649,-54.5499,40.1664,-39.8553,40.8255,3.23617,41.0306,-13.8587,41.2349,10.1142,41.2749,-18.5726,42.2723,-32.4063,42.4958,27.2608,42.6455,38.3189,42.6741,55.8955,44.1067,-8.89761,44.5655,-40.3047,44.9287,8.90739,45.5938,4.35286,45.5983,-23.6243,45.9038,-59.7376,46.1991,53.5064,46.2938,38.8405,47.0422,40.9556,48.0178,-28.9891,48.9585,-8.81983,49.879,-21.7579,49.9717,-43.0716,51.0806,49.8613,51.2035,9.02906,52.2672,59.9403,53.2351,-9.45831,53.4469,-21.6328,55.7312,47.7877,55.8123,-9.76519,56.0481,-64.8071,56.0797,32.2883,56.7125,-23.2484,56.8093,-74.2393,57.1493,-37.6201,57.2905,24.0535,57.3637,-36.2001,57.5895,71.3324,58.533,31.8837,59.356,63.0723,59.4634,40.0103,59.6864,-61.4001,59.7412,35.791,60.1701,12.4904,63.5003,-42.2939,63.606,-62.474,64.0062,-51.4871,64.1212,-59.3018,64.4734,-33.7983,64.948,15.6277,65.7335,17.5426,66.009,-34.017,66.3722,17.928,67.1539,19.1805,67.1653,15.8709,67.7087,-44.9538,68.4988,-55.045,68.8878,-30.5623,68.98,16.5098,69.0797,-3.35244,69.5453,-14.3036,70.1409,-41.8636,70.5144,-37.1448,70.5613,22.957,70.7665,-70.9311,71.3756,-3.25461,72.4589,6.96125,72.653,8.90025,72.8015,5.60511,73.2237,-5.45275,73.3448,2.50828,73.5125,66.3427,73.7237,10.1511,74.2484,33.1661,74.6371,1.71403,75.6195,41.0759,76.3652,-22.3709,76.9626,-5.08625,77.2866,-8.75408,78.0745,-11.8691,78.2328,-16.2054,78.3079,-12.9413,78.6345,-8.20164,79.1721,45.999,79.8939,-13.1768,79.996,-12.3156,80.6407,79.2308,81.2828,6.34972,81.5729,28.6079,82.0614,-20.7592,82.8031,-35.4704,82.9694,-76.3417,83.0017,-0.299083,83.1825,-17.8223,83.4063,-62.4899,83.7845,9.93417,84.0534,-1.20192,84.4112,21.1426,84.9123,-34.0741,85.1897,-1.94258,86.1165,-22.4475,86.1934,-65.7355,86.739,-14.8219,86.8212,-51.0667,86.9391,-9.66961,87.4566,-56.1665,87.7398,-35.7693,87.8298,-20.8775,88.5246,-63.091,88.5962,20.2764,88.7929,7.40703,89.1013,-14.168,89.3842,-35.2833,89.7866,-42.8151,89.8824,44.9474,89.9302,37.2128,90.5958,9.64736,90.864,19.6906,91.0301,23.2636,91.5389,-14.9353,91.893,14.7685,92.2412,2.49972,92.985,14.2088,93.7139,-6.27472,93.7196,22.5068,94.1381,-35.1407,94.9058,59.0109,95.0783,-30.0634,95.5285,-33.4363,95.675,-17.9559,95.74,22.5139,95.9421,4.59283,95.9879,-52.6957,97.2045,-7.03306,97.2408,20.2122,98.7641,-22.9648,99.1708,-19.2557,99.4279,16.3994,99.4403,-43.1959,100.983,25.1312,101.289,-16.7131,101.323,12.8961,102.048,-61.942,102.46,-32.5085,102.484,-50.6144,103.197,33.9614,103.548,-12.0386,103.554,-23.9284,104.034,-17.0543,104.319,58.4231,104.656,-28.9721,105.43,-27.9348,105.756,-23.8333,105.94,-15.6333,106.027,20.5703,107.098,-26.3932,107.187,-70.4992,107.785,30.2453,107.966,-0.492778,108.703,-26.7727,109.208,-67.9572,109.286,-37.0975,109.523,16.5405,110.031,21.9823,111.024,-29.3031,111.432,27.7983,111.679,49.2116,111.788,8.28942,112.308,-43.3019,113.65,31.8886,113.981,26.896,114.827,5.2275,115.312,-9.55108,115.455,-72.6061,116.112,24.3981,116.331,28.0263,117.257,-24.9123,120.896,-40.0032,121.886,-24.3044,121.983,-68.6171,122.149,-2.98378,122.383,-47.3366,124.129,9.18567,124.63,-76.92,125.016,27.2186,125.629,-59.5095,125.709,43.1884,126.434,-66.1365,127.567,60.7184,129.414,5.70381,129.689,3.34147,130.026,-35.3083,130.073,-52.922,130.154,-59.761,130.806,3.39867,130.822,21.4686,130.898,-33.1864,131.171,18.1549,131.176,-54.7086,131.674,28.76,131.694,6.41892,132.108,5.83789,132.633,-27.7101,133.849,5.94553,134.622,11.8578,134.804,48.0424,135.161,41.7834,135.612,-66.3958,135.907,47.1567,136.632,38.4523,136.999,-43.4326,137.742,-58.9669,138.301,-69.7175,138.591,2.31503,139.273,-59.2752,139.711,36.8029,140.264,34.3925,140.528,-55.0107,141.897,-8.65869,142.287,-2.76894,142.675,-40.4669,142.882,63.0618,142.996,-1.18467,143.218,51.6786,143.556,36.3976,146.463,23.7743,147.749,59.0391,147.869,-14.8466,148.026,54.0643,148.192,26.0071,149.216,-54.5678,149.718,-35.8909,151.833,16.7627,151.857,35.2447,151.985,-0.371639,152.094,11.9672,152.648,-12.3538,153.435,-70.0379,153.684,-42.1221,154.173,23.4173,154.271,-61.3323,154.275,42.9145,154.992,19.8419,155.582,41.4994,156.523,-16.8361,156.788,-31.0678,156.97,-58.7394,156.971,36.7075,157.573,-0.636972,158.868,-78.6078,159.326,-48.2256,160.739,-64.3945,160.885,-60.5666,161.692,-49.4201,162.406,-16.1941,163.328,34.2156,163.373,-58.8533,164.945,-18.2991,165.46,56.3823,165.933,61.7511,167.147,-58.9751,167.416,44.4986,167.915,-22.8256,168.527,20.524,168.56,15.4298,169.836,-14.7791,171.153,-10.8594,171.221,-17.684,172.851,69.3311,173.251,-31.8575,173.69,-54.2641,173.946,-63.0198,174.171,-9.80225,176.191,-18.3506,176.402,-66.7288,176.465,6.52981,176.513,47.7793,177.266,14.5723,178.227,-33.9081,178.457,53.6947,179.004,-17.1508,182.09,-50.7224,182.103,-24.7288,182.531,-22.6198,183.787,-58.7489,183.856,57.0326,183.952,-17.542,184.587,-79.3123,184.668,-0.787139,186.65,-63.0991,186.735,28.2686,187.01,-50.2306,187.467,-16.5151,187.791,-57.1126,188.019,-16.1959,188.117,-72.133,188.371,69.7882,188.438,41.3568,188.597,-23.3966,189.296,-69.1355,190.38,-48.9599,190.417,-1.44953,191.57,-68.1081,191.93,-59.6887,193.507,55.9598,193.902,3.39761,194.008,38.3182,195.545,10.9591,197.264,-23.118,197.498,17.5291,197.97,27.876,199.73,-23.1714,200.15,-36.7121,200.981,54.9254,201.298,-11.1613,202.761,-39.4073,203.674,-0.595944,204.972,-53.4664,206.886,49.3133,207.37,15.7978,207.376,-41.6877,207.404,-42.4737,208.671,18.3986,208.885,-47.2883,209.67,-44.8035,210.412,1.54458,210.956,-60.373,211.098,64.3758,211.672,-36.3687,213.224,-10.2741,213.918,19.1873,214.004,-5.99953,216.545,-45.3792,216.732,-83.6679,217.958,30.3711,218.02,38.3079,218.877,-42.1577,219.472,-49.4258,219.92,-60.8351,220.287,13.7283,220.482,-47.3881,220.628,-64.9746,220.765,-5.65742,221.247,27.0742,221.562,1.89294,221.966,-79.0447,222.677,74.1555,222.72,-16.0416,224.633,-43.1339,224.79,-42.1041,225.487,40.3906,226.018,-25.2819,228.072,-52.0991,228.875,33.3151,229.252,-9.38286,229.379,-58.8009,229.728,-68.6795,230.182,71.834,230.343,-40.6475,230.452,-36.2612,230.844,-59.3207,231.232,58.966,231.958,29.1055,233.232,31.3592,233.672,26.7149,233.701,10.5389,233.785,-41.1667,233.881,-14.7896,234.514,-42.5675,235.686,26.2955,236.014,77.7945,236.067,6.42553,236.547,15.4219,237.185,18.1418,237.399,26.0686,237.405,-3.43014,237.704,4.47758,237.74,-33.6271,238.167,42.45,238.456,-16.7296,238.787,-63.4297,239.112,15.6647,239.397,26.878,239.713,-26.1141,240.031,-38.3966,240.083,-22.6216,240.361,29.8511,240.474,58.5644,240.804,-49.2297,241.359,-19.8054,241.817,-36.7555,243.37,-54.6304,244.377,75.7547,244.58,-4.69261,244.935,46.3133,244.961,-50.1554,245.48,19.153,245.998,61.5141,246.796,-47.5547,247.352,-26.4319,247.555,21.4896,248.364,-78.897,248.526,42.4369,248.971,-28.216,249.29,-10.5671,250.323,31.6019,250.724,38.9225,250.773,-77.5166,251.492,82.0372,252.166,-69.0276,252.446,-59.0413,252.543,-34.2926,252.968,-38.0473,253.499,-42.362,254.418,9.37506,254.655,-55.9901,255.073,30.9263,257.197,65.7146,257.594,-15.7251,258.038,-43.2385,258.758,24.8396,258.762,36.8092,259.418,37.2913,260.207,-12.8469,260.921,37.1459,261.325,-55.5298,261.349,-56.3777,262.608,52.3014,262.685,26.1106,262.775,-60.6836,262.854,-23.9626,262.961,-49.876,263.054,86.5863,263.066,55.1728,263.402,-37.1037,263.733,12.5606,264.33,-42.9978,264.397,-15.3984,264.866,46.0063,265.354,-12.8752,265.622,-39.0299,265.868,4.56692,266.433,-64.7237,266.615,27.7225,266.89,-27.8307,266.896,-40.127,268.382,56.8724,269.063,37.2505,269.152,51.4889,269.441,29.2479,271.452,-30.4236,271.658,-50.0914,271.886,28.7625,272.145,-63.6681,273.441,-21.0588,274.407,-36.7613,275.248,-29.828,275.26,72.7337,275.329,-2.89711,275.807,-61.4939,276.043,-34.3843,276.743,-45.9683,276.993,-25.4212,277.207,-49.07,277.299,-14.5658,278.089,-39.7039,278.802,-8.24331,279.234,38.783,280.759,-71.4277,280.946,-38.3233,281.193,37.6051,281.414,-26.9908,281.794,-4.74783,281.871,-5.70508,282.52,33.3627,283.054,-62.1876,283.626,36.8986,283.68,-15.603,283.816,-26.2966,284.055,4.20353,284.071,-42.7106,284.169,-37.3432,284.238,-67.2335,284.432,-21.1066,284.681,-37.1071,284.736,32.6896,284.906,15.0685,285.653,-29.8801,285.778,-42.095,286.171,-21.7414,286.353,13.8637,286.562,-4.88233,286.604,-37.0628,286.735,-27.6698,287.087,-40.4966,287.368,-37.9043,287.507,-39.3407,288.138,67.6613,289.275,53.3682,289.409,-18.9529,290.418,-17.8472,290.804,-44.7996,290.971,-40.6156,291.374,3.11458,292.177,24.6652,292.426,51.7295,292.68,27.9597,294.007,-24.719,295.024,18.0139,295.262,17.4761,296.244,45.1307,296.565,10.6133,296.847,18.5343,297.043,70.2678,297.695,8.86739,298.118,1.00567,298.815,-41.8684,298.828,6.40794,299.077,35.0835,299.689,19.4921,299.934,-35.2762,300.147,-72.9102,300.275,27.7536,300.664,-27.7099,301.289,19.9909,302.174,-66.1793,302.826,-0.821472,304.513,-12.5449,305.253,-14.7814,305.557,40.2567,306.412,-56.7349,308.303,11.3033,309.387,14.5952,309.392,-47.2917,309.771,15.8382,310.358,45.2803,310.865,15.0747,311.24,-66.2032,311.524,-25.2705,311.552,33.9694,311.665,16.1248,311.919,-9.49569,312.492,-33.7797,312.955,-26.9191,313.702,-58.4541,315.323,-32.2578,316.487,-17.2327,317.585,10.1319,318.234,30.2271,318.62,10.0077,318.956,5.24808,319.484,-32.1725,319.644,62.5854,319.966,-53.4493,320.562,-16.8346,320.723,6.81111,321.61,-65.3681,321.667,-22.4114,322.165,70.5607,322.89,-5.57117,325.022,-16.6623,325.369,-77.3895,326.035,28.7432,326.046,9.875,326.161,25.645,326.76,-16.1266,326.934,-30.8983,328.482,-37.3648,330.209,-28.4538,331.446,-0.319833,331.529,-39.5431,331.609,-13.8695,331.752,25.3451,332.058,-46.9606,332.307,33.1725,332.535,-32.5484,332.549,6.19778,332.714,58.2012,333.992,37.7487,334.208,-7.78325,334.626,-60.2595,335.414,-1.38736,335.89,52.2295,336.129,49.4764,337.207,-0.0200556,337.317,-43.4956,337.383,47.7069,337.622,43.1234,337.662,-10.6779,337.822,50.2824,337.876,-32.346,338.839,-0.117361,340.164,-27.0436,340.365,10.8314,340.666,-46.8846,340.751,30.2213,341.516,-81.3816,341.633,23.5657,341.673,12.1741,342.138,-51.3167,342.398,-13.5925,342.42,66.2007,342.5,24.6017,343.154,-7.57967,343.663,-15.8208,343.987,-32.5397,344.412,-29.6218,345.22,-52.7541,345.943,28.0824,346.19,15.2054,346.72,-43.5203,347.361,-21.1725,347.589,-45.2466,348.972,-9.08769,349.29,3.28225,349.358,-58.2359,349.706,-32.5318,350.743,-20.1003,351.733,1.25583,351.992,6.37911,353.242,-37.8184,354.837,77.632,354.987,5.62736,355.512,1.78042,359.828,6.86358];

for (var i in constellation_lines) {
    line = constellation_lines[i];
    //console.log('line: ' + line);
    latlngs = [];
    var ra = 180.;
    var lastlng = 180. - ra;
    //var lastlng = ra2long_B(ra);
    for (var j in line) {
	s = line[j];
	//console.log('line: ' + s + ' RA,Dec ' + constellation_stars[2*s] + ', ' + constellation_stars[2*s+1]);
	ra = constellation_stars[2*s]
	lng = 180. - ra;
	//ra2long_B(ra);
	if (lng - lastlng > 180) {
	    lng -= 360;
	}
	if (lng - lastlng < -180) {
	    lng += 360;
	}
	lastlng = lng;
	latlngs.push(L.latLng(dec2lat(constellation_stars[2*s+1]),
			      lng));
    }
    var polyline = L.polyline(latlngs, {color: 'red'});
    conGroup.addLayer(polyline);
}
%}

// A scale bar that shows arcsec / arcmin / degrees rather than meters
AstroControl = L.Control.Scale.extend({
    options: {
	imperial: false,
	maxWidth: 300,
    },
    _updateMetric: function (maxMeters) {
	// meters -> arcsec
	maxArcsec = maxMeters / 30.87;
	maxUnit = maxArcsec;
	unitName = 'arcsec';

	if (maxArcsec > 7200) {
	    // degrees
	    maxUnit /= 3600;
	    unitName = 'deg';
	} else if (maxArcsec >= 180) {
	    // arcmin
	    maxUnit /= 60;
	    unitName = 'arcmin';
	}
	var unit = this._getRoundNum(maxUnit);
	this._mScale.style.width = this._getScaleWidth(unit / maxUnit) + 'px';
	this._mScale.innerHTML = unit + ' ' + unitName;
    },

    // Yep, astronomers even have different ideas about what numbers are round.
    // _getRoundNum: function (num) {
    // 	var pow10 = Math.pow(10, (Math.floor(num) + '').length - 1),
    // 	d = num / pow10;
    // 	d = d >= 10 ? 10 : d >= 5 ? 5 : d >= 3 ? 3 : d >= 2 ? 2 : 1;
    // 	return pow10 * d;
    // }

});

new AstroControl().addTo(map);

{% comment %}
AstroPolylineMeasure = L.Polyline.Measure.extend({
});

AstroMeasureControl = L.Control.MeasureControl.extend({
    onAdd: function(map) {
        var className = 'leaflet-control-draw';
        this._container = L.DomUtil.create('div', 'leaflet-bar');
	
	// This is the only line changed --
        this.handler = new AstroPolylineMeasure(map, this.options.handler);

        this.handler.on('enabled', function () {
            L.DomUtil.addClass(this._container, 'enabled');
        }, this);
        this.handler.on('disabled', function () {
            L.DomUtil.removeClass(this._container, 'enabled');
        }, this);
        var link = L.DomUtil.create('a', className+'-measure', this._container);
        link.href = '#';
        link.title = L.Control.MeasureControl.TITLE;
        L.DomEvent
            .addListener(link, 'click', L.DomEvent.stopPropagation)
            .addListener(link, 'click', L.DomEvent.preventDefault)
            .addListener(link, 'click', this.toggle, this);
        return this._container;
    }
});
//new AstroMeasureControl().addTo(map);
{% endcomment %}

</script>
</body>
{% endblock %}
