<html>
<head>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="/static/leaflet-src.js"></script>
<script src="/static/jquery-2.1.1.min.js"></script>

<style type="text/css">
#map { height: 100%; width: 100%; padding: 1;}

#thebody { margin:1; }

.info {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}
</style>
</head>

<body id="thebody">
<div id="map" />

<script>

MyTileLayer = L.TileLayer.extend({
    _loadTile: function (tile, tilePoint) {
        // this is just copied from the superclass
        tile._layer  = this;
        tile.onload  = this._tileOnLoad;
        tile.onerror = this._tileOnError;
        this._adjustTilePoint(tilePoint);
        tile.src     = this.getTileUrl(tilePoint);
        // this is special sauce - add zoom,x,y to tile object
        tile.x = tilePoint.x;
        tile.y = tilePoint.y;
        tile.tilex = tilePoint.x;
        tile.tiley = tilePoint.y;
        tile.z = tilePoint.z;
        console.log('loadtile: x,y ' + tile.tilex + ',' + tile.tiley);
        // copied
        this.fire('tileloadstart', {
            tile: tile,
            url: tile.src,
        });
    },

});

function catLoaded(result) {
    console.log('catloaded:' + result);

    if (!showSources) {
        return;
    }

    console.log('catloaded:' + result['rd']);
    rdlist = result['rd']
    var circleList = new Array(rdlist.length);
    for (i=0, len=rdlist.length; i<len; i++) {
        r = rdlist[i][0];
        d = rdlist[i][1];
        lat = d;
        lng = 180 - r;
        circleList[i] = L.circle([lat, lng], 10);
    }
    circles = L.layerGroup(circleList);
    
    //circles.addTo(map);
    sourcesGroup.addLayer(circles);

    // save this for later.
    key = ''+result['zoom']+':'+result['x']+':'+result['y'];
    catLayers[key] = circles;
}

function onTileLoadStart(e) {
    tile = e.tile;

    key = '' + tile.z + ':' + tile.x + ':' + tile.y;
    visibleTiles[key] = true;

    console.log('onTileLoadStart: showSources = ' + showSources);

    if (!showSources) {
        return;
    }

    // fugly
    tilePoint = L.Point(tile.x, tile.y);
    caturl = L.Util.template('{{ caturl }}', L.extend({
        s: tiles._getSubdomain(tilePoint),
        //s: 'a',
        z: tile.z,
        x: tile.tilex,
        y: tile.tiley
    }));
    //, tiles.options));
    console.log('caturl: ' + caturl);

    $.getJSON(caturl, catLoaded);
    console.log('TileLoadStart: z ' + tile.z +
                ', x,y (' + tile.x + ',' + tile.y + ')' +
                tile.tilex + ',' + tile.tiley);
}


function onTileUnload(e) {
    if (!showSources) {
        return;
    }
    tile = e.tile;
    // console.log('TileUnload: ' + tile.toString());
    console.log('TileUnload: z ' + tile.z +
                ', x,y (' + tile.tilex + ',' + tile.tiley + ')');
    key = ''+tile.z+':'+tile.tilex+':'+tile.tiley;
    circles = catLayers[key];
    map.removeLayer(circles);
    delete catLayers[key];
}

function onMapClick(e) {
    ra = 180 - e.latlng.lng;
    dec = e.latlng.lat;
    popup.setLatLng(e.latlng)
        .setContent("Click: RA,Dec = " + ra.toFixed(4) + ", " + dec.toFixed(4) +
                    "<br/><a href=\"{{ baseurl }}ra=" + ra.toFixed(4) +
                    '&dec=' + dec.toFixed(4) + '&zoom=' + map.getZoom()
                    + "\">link here</a>")
        .openOn(map);
}

function onMouseMove(e) {
    ra = 180 - e.latlng.lng;
    dec = e.latlng.lat;
    info._div.innerHTML = 'RA,Dec = ' + ra.toFixed(4) + ", " + dec.toFixed(4);
}

// "Sources", "Bricks", "CCDs" button checked
function overlayAdded(e) {
    console.log('OverlayAdded: ' + e.name);
    if (e.name == 'Sources') {
        console.log('Set showSources = True');
        // set global 
        showSources = true;
        // request catalogs for currently-visible tiles
    }
}

// "Sources", "Bricks", "CCDs" button unchecked
function overlayRemoved(e) {
    console.log('OverlayRemoved: ' + e.name);
    if (e.name == 'Sources') {
        console.log('Set showSources = False');
        // set global 
        showSources = false;
        // remove all catalogs
    }
}

var showSources = false;
var sourcesGroup = L.layerGroup([]);
//var sourceGroups = {};
catLayers = {};

var visibleTiles = {};

var map = L.map('map').setView([ {{ lat }}, {{ long }}], {{ zoom }});

map.on('click', onMapClick);

tiles = new MyTileLayer('{{ tileurl }}', {
    maxZoom: 18,
    attribution: 'DECaLS',
    id: '{{ layer }}',
    // ?
    unloadInvisibleTiles: true,
});
tiles.addTo(map);

//{% if showsources %}
tiles.on('tileloadstart', onTileLoadStart);
tiles.on('tileunload',    onTileUnload);
//{% endif %}

var info = L.control();
info.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'info');
    this._div.innerHTML = '{{ ra|floatformat:4}}, {{ dec|floatformat:4}}';
    return this._div;
};
info.addTo(map);

map.on('mousemove', onMouseMove);

var baseMaps = {
    "DECaLS": tiles,
};

//var src = L.marker([7.4106, 244.7302]);
//var sources = L.layerGroup([src]);

var br = L.marker([7.4246, 244.6618]);
var bricks = L.layerGroup([br]);

var ccd = L.marker([7.3677, 244.6700]);
var ccds = L.layerGroup([ccd]);

var overlayMaps = {
    "Sources": sourcesGroup,
    "Bricks": bricks,
    "CCDs": ccds,
};

L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

map.on('overlayadd', overlayAdded);
map.on('overlayremove', overlayRemoved);

{{ polygons }}

</script>

</body>

</html>
